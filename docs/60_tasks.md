# Tasks Board (source of truth for execution; Orchestrator only)

## Status
- TODO / DOING / REVIEW / DONE / BLOCKED

## Rules
- Task IDs are stable. If splitting, use suffix (`T-010a`, `T-010b`).
- Every TODO task must declare `blocked_by`.
- REVIEW には Review Pack (`docs/85_reviews/RP-...`) を添付する。
- DONE は証跡（`just` 実行結果/test/review、必要時のみ commit/PR）を短く残す。
- online/e2e source test（codex/claude）を走らせる前に `just preflight-online` を必須実行する。

## TODO
- [ ] (none)

## DOING
- [ ] (none)

## REVIEW
- [ ] (none)

## BLOCKED
- [ ] (none)

## DONE (keep short)
- [x] T-123 (P1) [MVP] Provider Switching — Generic Cross-Provider Arbitration
  - Evidence: `is_heartbeat: bool` added to `SourceEventV2` (serde default=false) + `CodexRawEvent`. Codex poller computes `is_heartbeat=true` when status/pane unchanged and time elapsed ≥2s; all notifications/capture events `is_heartbeat=false`. `DaemonProjection.last_real_activity: HashMap<pane_id, HashMap<Provider, DateTime>>` tracks last non-heartbeat Det event per provider. `select_winning_provider()` picks most-recently-active Det provider; no conflict if ≤1 Det provider. `tick_freshness` clears stale pane entries. Covers Codex→Claude, Claude→Codex, Any→zsh, future Gemini. 10 new tests (8 projection + 2 translate). `just verify` PASS (641 tests).
- [x] T-122 (P1) [MVP] Claude JSONL deterministic source (`agtmux-source-claude-jsonl`)
  - Evidence: New crate `agtmux-source-claude-jsonl` (4 modules: discovery, translate, watcher, source). CWD-based session discovery via `sessions-index.json`. File watcher (EOF seek, partial line, inode rotation). Source rank: `ClaudeHooks(0) > ClaudeJsonl(1) > Poller(2)`. Wired into poll_loop Step 6b + 8c + compaction. Gateway registers 4 sources. 20 new tests. `just verify` PASS (626 tests).
- [x] T-121 (P0) [MVP] Pane-first resolver grouping + pane_generation fallback
  - Evidence: `apply_events()` grouping key changed from `session_key` to `pane_id` (fallback: `session_to_pane` → `session_key`). `resolver_states` keyed by group_key. Per-group multi-session projection. `deterministic_fresh_active` references pane group_key. `pane_generation` fallback from existing pane state. 9 new cross-session tests (3 confirmed bugs → all PASS after fix). ADR-20260226-pane-first-resolver-grouping.md. FR-031a. `just verify` PASS (606 tests).
- [x] T-119 (P1) Codex App Server → pane_id correlation (thread.cwd ↔ tmux pane cwd matching)
  - Evidence: Per-cwd `thread/list` queries (API `cwd` filter param). `PaneCwdInfo` struct + `build_cwd_pane_map()` for disambiguation (Codex process_hint wins). `CodexRawEvent` extended with `pane_generation`/`pane_birth_ts`, passthrough in `translate()`. `poll_threads()` accepts `&[PaneCwdInfo]`, poll_loop builds from `last_panes`+`generation_tracker`+`snapshots`. `FakeTmuxBackend.with_pane_cwd()` for testing. 5 new tests (4 cwd map + 1 translate passthrough). `just verify` PASS (599 tests).
- [x] T-120 (P1) Codex App Server protocol fix + reliability hardening
  - Evidence: B1: `"jsonrpc": "2.0"` on all messages. B2: `"params": {}` on initialized, `"capabilities": {}` on initialize. B3: `used_appserver` based on `is_alive()`. B4: reconnection with exponential backoff (`2^min(failures,6)` ticks), `codex_appserver_had_connection` flag (poll_tick only reconnects dead clients, initial spawn in `run_daemon`). B5: `poll_threads()` outside mutex (take/put pattern). B6: `CodexSourceState.set_appserver_connected()` → health `Healthy`/`Degraded`. C1: deleted `discover_appserver`, `poll_codex_appserver`, `CodexPollerConfig`, `--codex-appserver-addr`. Protocol: `result.data` (not `.threads`), `status.type` (object), `updated_at` (not `lastUpdated`). `just verify` PASS (594 tests).
- [x] T-113a (P1) [MVP] Codex App Server integration: stdio client + capture fallback
  - Evidence: `CodexAppServerClient` (JSON-RPC 2.0 over stdio): spawn `codex app-server`, initialize handshake, `thread/list` polling, `turn/started`/`turn/completed`/`thread/status/changed` notification → `CodexRawEvent`. Capture-based fallback: `parse_codex_capture_events()` extracts NDJSON from tmux capture for `codex exec --json` output. `CodexCaptureTracker` for cross-tick dedup. poll_tick Step 6a: app-server (primary) → capture (fallback). API ref: https://developers.openai.com/codex/app-server/. 12 new tests. `just verify` PASS (597 tests).
- [x] T-118 (P2) [Post-MVP] LatencyWindow → poll tick metrics + path escaping fix
  - Evidence: `LatencyWindow` + `last_latency_eval` wired into DaemonState. poll_tick Step 12: tick timing → SLO evaluation → breach/degraded logging → cached eval. `latency_status` JSON-RPC method (read-only, Codex F4). `shell_quote()` for path escaping in setup_hooks (Codex F5). 5 new tests. `just verify` PASS (570 tests).
- [x] T-115 (P2) [Post-MVP] TrustGuard → UDS admission gate (warn-only)
  - Evidence: `TrustGuard` wired into DaemonState (UID via getuid(), nonce=PID+nanos, 3 sources pre-registered). `source.ingest` schema extended (optional source_id/nonce), warn-only admission (unregistered/nonce mismatch → log, continue). `daemon.info` JSON-RPC method (nonce, version, pid). 5 new tests. `just verify` PASS (585 tests).
- [x] T-117 (P2) [Post-MVP] SourceRegistry → connection lifecycle
  - Evidence: `SourceRegistry` wired into DaemonState. `source.hello` (protocol check + lifecycle), `source.heartbeat`, `list_source_registry` JSON-RPC methods. poll_tick Step 11b: staleness check. 6 new tests. `just verify` PASS (580 tests).
- [x] T-116 (P2) [Post-MVP] CursorWatermarks → gateway cursor pipeline
  - Evidence: `CursorWatermarks` + `InvalidCursorTracker` wired into DaemonState. Step 9a: `advance_fetched()` on gateway pull → `record_valid()` / recovery (RetryFromCommitted/FullResync). Step 11a: `commit()` on gateway commit_cursor. `parse_gw_cursor()` helper. 4 new tests. `just verify` PASS (574 tests).
- [x] T-114 (P1) [MVP] Deterministic session key wiring + CLI title quality
  - Evidence: `PaneRuntimeState.session_key` added, `build_pane_list()` passes `deterministic_session_key` for deterministic panes → `DeterministicBinding` title quality. `summary_changed` includes `deterministic`/`heuristic` counts. 2 new tests. `just verify` PASS (565 tests).
- [x] T-113 (P1) [MVP] Codex appserver poller skeleton
  - Evidence: `codex_poller.rs` with `discover_appserver()` (config + env), `poll_codex_appserver()` (socket check, protocol TBD). `--codex-appserver-addr` CLI option (env: `CODEX_APPSERVER_ADDR`). 4 tests. `just verify` PASS (563 tests).
- [x] T-112 (P1) [MVP] UDS source.ingest + Claude hook adapter + setup-hooks CLI
  - Evidence: `source.ingest` JSON-RPC handler (claude_hooks, codex_appserver dispatch). `scripts/agtmux-claude-hook.sh` (fire-and-forget, jq+socat). `agtmux setup-hooks` CLI (project/user scope, 5 hook types). 9 new tests (4 server + 5 setup_hooks). `just verify` PASS (558 tests).
- [x] T-111 (P1) [MVP] DaemonState expansion + deterministic source pipeline wiring
  - Evidence: codex/claude `compact()` + `compact_offset` added. DaemonState expanded with `codex_source`/`claude_source`. poll_tick steps 8a/8b + compaction. Gateway registers 3 sources. 11 new tests (6 source compact + 5 poll_loop). `just verify` PASS (549 tests).
- [x] T-110 (P1) [MVP] Push event methods: state_changed + summary_changed
  - Evidence: `state_changed` returns version-based changes with pane/session state. `summary_changed` returns managed/unmanaged counts and change flags. Both accept `since_version` param. 4 new tests. `just verify` PASS (536 tests).
- [x] T-109 (P1) [MVP] Title resolver wiring into list_panes API
  - Evidence: `resolve_title()` called in `build_pane_list()` for managed (HeuristicTitle) and unmanaged (Unmanaged fallback) panes. `title` + `title_quality` fields added to JSON response. 1 new test. `just verify` PASS (532 tests).
- [x] T-108 (P1) [MVP] Runtime hardening: API completeness + memory compaction + SIGTERM
  - Evidence: (a) `signature_reason` + `signature_inputs` added to `list_panes` API (FR-024). (b) Poller + gateway buffer compaction wired into poll_loop (compact_offset cursor compatibility). (c) SIGTERM handler added via `tokio::signal::unix`. `just verify` PASS (531 tests = 526 + 5 new).
- [x] T-107 (P1) [MVP] Detection accuracy + activity_state display
  - Evidence: Capture-based 4th detection signal (WEIGHT_POLLER_MATCH=0.78), stale title suppression (title-only + shell + no capture → None), per-pane activity_state + provider in list-panes output. Codex+Claude parallel review adopted (capture tokens tightened: `╭ Claude Code`/`codex>`, shell list expanded: nu/pwsh/tcsh/csh, capture_match wired through payload→poller_match, provider as Option, changed condition updated). `just verify` PASS (525 tests = 514 existing + 11 new).
- [x] T-106 (P1) test strategy + quality gates for runtime crates
  - Evidence: FakeTmuxBackend (mock TmuxCommandRunner) + 12 poll_tick integration tests + 4 build_pane_list unit tests = 16 new runtime tests. E2E smoke script (`just test-e2e-status`). `just verify` PASS (514 tests). `just test-e2e-status` PASS with live tmux.
- [x] T-105 (P1) CLI polish: tmux-status, socket targeting, --poll-interval-ms
  - Evidence: `agtmux tmux-status` outputs `A:4 U:13`. `--tmux-socket`, `AGTMUX_TMUX_SOCKET_PATH/NAME` env supported. `--poll-interval-ms` configurable.
- [x] T-104 (P0) UDS JSON-RPC server + client CLI
  - Evidence: UDS server (connection-per-request, dir 0700, socket 0600, stale cleanup). `agtmux status` connects and prints pane info. 3 methods: list_panes, list_sessions, list_source_health.
- [x] T-103 (P0) poll loop: tmux -> poller -> gateway -> daemon pipeline
  - Evidence: poll_loop.rs wires tmux → poller → gateway → daemon. Unmanaged panes tracked via last_panes + build_pane_list merge. Error recovery (log+skip on capture failure).
- [x] T-102 (P0) runtime skeleton: binary + CLI + daemon + logging
  - Evidence: `agtmux` binary with clap CLI (daemon/status/list-panes/tmux-status). tracing + tracing-subscriber. Signal handling (ctrl_c). `just verify` PASS with 8 crates.
- [x] T-101b (P0) agtmux-tmux-v5: capture + inspection + conversion + generation
  - Evidence: capture_pane, inspect_pane_processes, PaneGenerationTracker (5 tests), to_pane_snapshot (3 tests). cargo test -p agtmux-tmux-v5 PASS.
- [x] T-101a (P0) agtmux-tmux-v5: executor + list_panes parser
  - Evidence: TmuxCommandRunner trait, TmuxExecutor, tab-delimited list_panes parser (10 tests), TmuxPaneInfo, TmuxError (thiserror). cargo test -p agtmux-tmux-v5 PASS.
- [x] T-100a (P0) cursor contract fix: sources always return current position
  - Evidence: 3 sources fixed to always return `Some(current_pos)`. Gateway always overwrites tracker cursor. 2 new no-re-delivery tests added. 471 tests pass.
- [x] T-100 (P0) docs: runtime integration design
  - Evidence: 20_spec.md, 30_architecture.md (C-015/C-016 + MVP topology), 40_design.md (Section 9), 50_plan.md, 60_tasks.md, 90_index.md updated. ADR-20260225-mvp-single-process-runtime.md created. Codex + Opus review adopted.
- [x] T-033 (P2) poller baseline quality spec
  - Evidence: `docs/poller-baseline-spec.md` + `accuracy.rs` 12 tests + fixture 320 windows + `just poller-gate` PASS
- [x] T-041 (P2/P3) cursor contract hardening
  - Evidence: 18 tests pass, two-watermark + safe rewind + invalid cursor streak/resync
- [x] T-043 (P3) latency window SLO gate
  - Evidence: 15 tests pass, rolling p95 + breach counting + degraded alert
- [x] T-047 (P2/P3) UDS trust admission guard
  - Evidence: 15 tests pass, peer uid + source registry + nonce check
- [x] T-048 (P2/P3) source.hello + registry lifecycle
  - Evidence: 18 tests pass, 4-state lifecycle + hello handshake + staleness + socket rotation
- [x] T-049 (P3) snapshot/restore 基盤
  - Evidence: 15 tests pass, snapshot manager + policy + restore dry-run checker
- [x] T-051 (P4) observability alert routing
  - Evidence: 16 tests pass, severity-leveled alert ledger + auto-resolve + policy enforcement
- [x] T-052 (P4) supervisor strict runtime contract
  - Evidence: 18 tests pass, DependencyGate + FailureBudget + HoldDownTimer
- [x] T-053 (P3) binding projection 並行更新制御
  - Evidence: 15 tests pass, single-writer + CAS + conflict retry + rollback prevention
- [x] T-070 (P5) migration/canary/rollback runbook
  - Evidence: `docs/runbooks/migration-canary-rollback.md` + RP-T070
- [x] T-071 (P5) backup/restore runbook
  - Evidence: `docs/runbooks/backup-restore.md` + RP-T071
- [x] T-010 (P0) v5 crate/workspace skeleton
  - Evidence: 6 crates, `just verify` pass
- [x] T-020 (P1) tier resolver + unit/replay
  - Evidence: 35 resolver tests pass, dedup/freshness/rank suppression/re-promotion
- [x] T-011 (P1) poller logic reusable crate
  - Evidence: detect + evidence modules, 24 tests pass
- [x] T-012 (P1) source health FSM
  - Evidence: 31 health transition tests pass, 6-state FSM
- [x] T-013 (P1) title resolver + handshake priority
  - Evidence: 25 title tests pass, 5-tier priority + canonical session
- [x] T-030 (P2) codex appserver source server
  - Evidence: 10 tests pass, translate + source + cursor + health
- [x] T-031 (P2) claude hooks source server
  - Evidence: 11 tests pass, translate + source + cursor clamp fix
- [x] T-032 (P2) poller fallback server
  - Evidence: 40 tests pass, detection + evidence + pagination
- [x] T-040 (P2) gateway aggregation/cursor/health
  - Evidence: 23 tests pass, multi-source merge + cursor + health tracking
- [x] T-044 (P1/P3) pane signature classifier v1
  - Evidence: 27 tests pass, deterministic/heuristic/none + weights + guardrails
- [x] T-045 (P3) signature hysteresis/no-agent demotion
  - Evidence: 25 tests pass, idle/running/demotion windows + flap suppression
- [x] T-042 (P3) pane-first binding state machine
  - Evidence: 34 tests pass, 4-state FSM + generation tracking + tombstone grace + representative selection
- [x] T-050 (P3) daemon v5 projection + client API
  - Evidence: 25 tests pass, list_panes/list_sessions/changes_since + resolver integration
- [x] T-046 (P3) signature fields API exposure
  - Evidence: 9 new tests (34 total daemon), classifier integration + API contract + snapshot tests
- [x] T-060 (P4) supervisor + UI semantics
  - Evidence: 19 tests pass, restart backoff/holddown + startup order + UI labels (agents/unmanaged)
- [x] T-034 (P2) [US-001][US-004] source-specific test scripts を整備
  - Evidence: `scripts/tests/test-source-{codex,claude,poller}.sh` を追加し、`just preflight-online` / `just test-source-*` を実行
  - Notes: testは `/tmp/agtmux-e2e-*` の隔離git workspaceで実行し、完了時に tmux session/workspace/process を cleanup
- [x] T-035 (P2) [US-005] e2e reliability stress (10x + matrix) を実施
  - Evidence: `ITERATIONS=10 WAIT_SECONDS=30 PROMPT_STYLE=compact AGENTS=codex,claude just test-e2e-batch` -> codex 10/10, claude 10/10
- [x] T-009 (P0) [US-005] `just` ベースの local test/quality harness 初期整備
  - Evidence: root `justfile` 追加（`fmt` / `lint` / `test` / `verify` / `preflight-online` / `test-source-*`）
- [x] T-001 (P0) [US-005] docs-first baseline を v5 要件で再編
  - Evidence: `docs/00_router.md` 〜 `docs/90_index.md` をテンプレ準拠で再構成
- [x] T-002 (P0) [US-005] v5方針のユーザー確認を反映
  - Evidence: deterministic source固定、JSON-RPC over UDS、`agents` 英語固定、poller 85% baseline 位置づけ
- [x] T-003 (P0) [US-004][US-003] cursor/binding/latency 設計を docs へ反映
  - Evidence: FR-018〜FR-023 を docs に固定
- [x] T-004 (P0) [US-003] pane signature v1 設計を docs へ反映
  - Evidence: FR-024〜FR-031 を docs に固定
- [x] T-005 (P0) [US-005] review 指摘（品質/信頼境界/運用復旧）を docs 契約へ反映
  - Evidence: FR-032〜FR-038 を docs に固定
- [x] T-006 (P0) [US-005] review 指摘（supervisor/ack/registry/FSM並行制御）を docs 契約へ反映
  - Evidence: FR-039〜FR-047 を docs に固定
- [x] T-000 docs skeleton imported from template
  - Evidence: `~/Downloads/docs-first-template/docs` を基に初期構造作成済み
