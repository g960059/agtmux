# AGTMUX 実装計画 (v0.5)

Date: 2026-02-13
Status: Draft
Source Spec: `docs/agtmux-spec.md`

## 1. 目的

本文書は、v0.5 仕様更新後の AGTMUX のデリバリー計画を定義する。
フェーズ目標、ゲート条件、依存関係の順序、および変更管理ルールを規定する。

## 2. コーディング前の契約凍結

以下の契約はフェーズ開始の前提条件として扱われ、明示的な仕様更新なしに変更してはならない:

- アクションのフェイルクローズド動作（`action_snapshot`、`runtime_id`、`state_version`、鮮度チェック）。
- アクションの冪等性（`actions(action_type, request_ref)` のユニーク制約とリプレイ動作）。
- Watch ストリームの再開契約（`cursor=<stream_id:sequence>`）。
- ランタイム識別ルール（`tmux_server_boot_id`、`pane_epoch`、失効ランタイムの拒否）。
- イベントの順序付けと重複排除セマンティクス（`source_seq`、`effective_event_time`、ソースカーソルモデル）。
- デーモン API トランスポート契約（`HTTP/JSON over UDS`、ヘルスエンドポイント、ライフサイクルセマンティクス）。
- ターゲットヘルス遷移ポリシーおよび SSH 実行タイムアウト/リトライ動作。

## 3. デリバリー原則

- 垂直スライスで出荷する: 各機能ごとに API + ステートエンジン + CLI をセットで提供。
- 契約テストが失敗した場合は昇格をブロックする。
- 完全性よりも安全性を優先する（不正確な確定状態よりも `unknown` を選択）。
- 共有 API 契約を通じて CLI とデーモンの動作を整合させる。

## 4. フェーズロードマップ

| フェーズ | 主要成果 | 必須ゲート |
| --- | --- | --- |
| 0 | コアランタイムと決定論的ステートエンジン | 順序付け/重複排除リプレイ、ランタイムガード、スキーママイグレーションチェック |
| 1 | 可視性 MVP（Claude + Codex、マルチターゲット読み取り） | Watch カーソル互換性、部分結果動作、アタッチ安全性 |
| 1.5 | 制御 MVP | スナップショット障害テスト、冪等アクションリプレイ、監査相関 |
| 2 | Gemini + 信頼性強化 | ドリフト/障害回復テスト、スキーマ互換性 |
| 2.5 | アダプター拡張 | 各新規アダプターの契約スイートパス |
| 3 | macOS 常駐アプリ | API v1 互換性およびアクション安全性の同等性 |

## 5. フェーズ詳細

### Phase 0: コアランタイム

目的:
- 決定論的な取り込みと正準状態の永続化を構築する。

スコープ内:
- `TargetExecutor` の実装とデーモン境界（`agtmuxd`）。
- デーモンのトランスポートとライフサイクルの基盤（`HTTP/JSON over UDS`、単一インスタンスロック、グレースフルシャットダウン/リスタート動作）。
- ターゲットごとの tmux トポロジーオブザーバー。
- SQLite スキーマ + マイグレーション（`runtimes`、`events`、`event_inbox`、`runtime_source_cursors`、`states`、`actions`、`action_snapshots`）。
- ランタイム識別 + ペインエポックのライフサイクル。
- 順序付け/重複排除の適用パス。
- 失効/ヘルス遷移のためのリコンサイラー。

開始条件:
- 仕様セクション 7.2、7.3、7.4、7.7 が凍結済みであること。

終了条件:
- トポロジーとステート行が永続化され、複数ターゲットに対してクエリ可能であること。
- 失効状態が設定された TTL 内に安全な値に収束すること。
- 決定論的な順序付けと重複排除動作がリプレイテストで検証済みであること。
- アクティブランタイムのユニーク制約が DB レベルで強制されていること。
- セキュリティ/パフォーマンスのベースラインテストがグリーンであること（`TC-011`、`TC-012`、`TC-013`）。
- ターゲット実行およびトポロジー監視テストがグリーンであること（`TC-040`、`TC-041`）。
- tmux + ssh シナリオの CI/Nightly 実行ベースラインが存在し、リプレイアーティファクトを保存していること。

### Phase 1: 可視性 MVP

目的:
- ホスト + VM ターゲット間で Claude/Codex の手動ポーリングを不要にする。

スコープ内:
- ターゲットマネージャー（`add/connect/list/remove`）。
- Claude および Codex アダプター。
- リストコマンド（`panes/windows/sessions`）+ Watch ストリーム。
- API/CLI 同等性のための構造化エラーエンベロープの基盤。
- アタッチフローのための共有アクション書き込みパス/冪等性（`actions`、`request_ref`）。
- 共有アクション基盤を使用したフェイルクローズドスナップショット検証付きアタッチ。
- API v1 読み取り/Watch エンドポイント。
- アタッチパスのための最小限の API 書き込みエンドポイント。

開始条件:
- Phase 0 のゲートを通過済みであること。

終了条件:
- Claude/Codex ワークフローで手動ポーリングが不要になっていること。
- 部分的なターゲット障害下でリスト/Watch が使用可能であること。
- 可視性レイテンシ p95 <= 2s（定義済みベンチマークプロファイル）。
- Watch jsonl スキーマ互換性テストがパスすること。
- 読み取り/アタッチパスの API/CLI エラーエンベロープ基盤が安定していること。
- アタッチの失効ランタイム拒否テストがパスすること。
- グルーピングおよびマルチターゲット集約セマンティクステストがパスすること（`TC-042`、`TC-043`）。

### Phase 1.5: 制御 MVP

目的:
- 単一の制御面からの安全なアクション実行。

スコープ内:
- `send`、`view-output`、`kill`。
- API v1 書き込みエンドポイント。
- 全アクションタイプに対する共有冪等リクエスト処理（`request_ref`）。
- `action_id` 相関によるアクション監査証跡。

開始条件:
- Phase 1 のゲートを通過済みであること。

終了条件:
- 制御アクションが失効スナップショット/ランタイムを拒否すること。
- 失効アクション試行が統合テストで拒否されること。
- `action_id` によるアクションからイベントへの相関がクエリ可能であること。
- 冪等リプレイテストがパスすること。

### Phase 2: Gemini + 信頼性強化

目的:
- 第三のアダプターサポートと運用回復力。

スコープ内:
- Gemini アダプター。
- 再接続/バックオフのチューニング。
- JSON スキーマの堅牢化と契約互換性チェック。
- より高機能なリスト/Watch フィルターおよびソート。

終了条件:
- 3つのアダプターすべてが、ターゲット切断/再接続およびイベント順序乱れシナリオ下で安定的に収束すること。

### Phase 2.5: アダプター拡張

目的:
- コアの再設計なしに新規アダプターを追加する。

スコープ内:
- Copilot CLI アダプター (v1)。
- Cursor CLI アダプター (v1)。

終了条件:
- 両アダプターが共有アダプター契約およびステート収束スイートをパスすること。

### Phase 3: macOS 常駐アプリ

目的:
- バックエンドのフォークなしにデーモン API 上でオペレーター UI を提供する。

スコープ内:
- グローバル/セッション/ウィンドウ/ペイン画面。
- CLI と同等の安全なアクション。

終了条件:
- すべてのアプリアクションおよび Watch フローに対して API v1 互換性が検証済みであること。

## 6. 依存関係と順序ルール

- Phase 1 の Watch/読み取り契約が安定するまで制御アクションは実施しない。
- Phase 2 のゲートバンドル（`TC-033`、`TC-034`、`TC-035`、`TC-046`、`TC-047`、`TC-048`、`TC-052`）がグリーンになるまでアダプター拡張は実施しない。
- API v1 互換性契約およびテストスイートが安定するまでアプリは出荷しない。
- アタッチの出荷にはアクションスナップショット + 冪等性コアテストがグリーンであることが必要。

## 7. ゲート拘束

- フェーズ完了判定は、`docs/test-catalog.md` の対応テストバンドルが完全にグリーンでない限りブロックされる。
- 免除されたテストは、有効期限付きで明示的に承認・記録されなければならない。

## 8. 変更管理

- 契約レベルの変更は以下を更新しなければならない:
  - `docs/agtmux-spec.md`
  - `docs/implementation-plan.md`
  - `docs/tasks.md`
  - `docs/test-catalog.md`
- すべての契約変更には明示的なマイグレーションと後方互換性に関する注記が必要。

## 9. 報告頻度

- 毎週: フェーズ状況、ブロッカー、主要リスク。
- PR ごと: 紐付けタスク ID + 紐付けテスト ID + ゲートへの影響。
- フェーズ完了時: ゲートチェックリストのエビデンスおよび残留リスクの要約。

## 10. テスト実行プロファイル

- CI プロファイル:
  - tmux（`>= 3.3`）およびローカル ssh テストハーネスを備えた Linux 上で実行。
  - CI ラベル付きの全テスト（Watch/アクション契約およびターゲットエグゼキューターフローを含む）を実行すること。
- Nightly プロファイル:
  - マルチターゲットプロファイル（ホスト + ssh ターゲット）をベンチマークワークロードで実行。
  - Nightly ラベル付きテストを実行し、アーティファクト（ログ、メトリクス、シード、フィクスチャバージョン）を公開すること。
- Manual+CI プロファイル:
  - 再現可能なランブックおよび PR に添付されたエビデンスアーティファクトを使用。
